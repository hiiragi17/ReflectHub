# Testing Guide

このプロジェクトでは、[Vitest](https://vitest.dev/)を使用してテストを実行しています。

## セットアップ

テストに必要な依存関係は既にインストールされています：
- `vitest` - テストランナー
- `@testing-library/react` - Reactコンポーネントのテスト
- `@testing-library/jest-dom` - DOM要素のアサーション
- `@testing-library/user-event` - ユーザーインタラクションのシミュレーション
- `jsdom` - ブラウザ環境のシミュレーション

## テストの実行

### すべてのテストを実行
```bash
pnpm test
```

### テストを1回だけ実行（CI用）
```bash
pnpm test:run
```

### UIモードでテストを実行
```bash
pnpm test:ui
```

### カバレッジレポート付きでテストを実行
```bash
pnpm test:coverage
```

## テストファイルの場所

テストファイルは以下の場所に配置されています：
- `src/utils/*.test.ts` - ユーティリティ関数のテスト
- `src/services/*.test.ts` - サービス層のテスト
- `src/hooks/*.test.ts` - カスタムフックのテスト
- `src/components/**/*.test.tsx` - コンポーネントのテスト

## 既存のテストカバレッジ

### ✅ バリデーションユーティリティ (`src/utils/validation.test.ts`)
- 61テスト
- 以下の機能をカバー：
  - 改行の正規化
  - HTMLサニタイゼーション
  - 必須フィールドチェック
  - 文字数制限（グラフィーム対応）
  - 禁止文字チェック
  - HTMLコンテンツ検出
  - フィールドバリデーション
  - フォームバリデーション
  - フォームデータのサニタイゼーション

### ✅ 認証ユーティリティ (`src/utils/auth.test.ts`)
- 30テスト
- 以下の機能をカバー：
  - Supabaseクライアントの作成
  - リダイレクトURLの検証（セキュリティ）
  - ログアウト処理
  - セッション取得
  - ユーザー情報取得

### ✅ useValidationフック (`src/hooks/useValidation.test.ts`)
- 22テスト
- 以下の機能をカバー：
  - フォームデータのバリデーション
  - 単一フィールドのバリデーション
  - エラーのクリア
  - フィールドエラーのクリア
  - フォームデータのサニタイゼーション

### ✅ カレンダーコンポーネント (`src/components/reflection/Calendar.test.tsx`)
- 13テスト
- 以下の機能をカバー：
  - カレンダーのレンダリング（日本語ロケール対応）
  - 空のリフレクション/フレームワークの処理
  - 日付別のリフレクショングループ化
  - 同一日付の複数リフレクション処理
  - 日付フォーマット（YYYY-MM-DD）
  - 日付クリック時のコールバック
  - データ処理とメモ化
  - エッジケース（無効な日付、存在しないフレームワーク）
  - キーボードナビゲーション

### ✅ カレンダーエントリーコンポーネント (`src/components/reflection/CalendarEntry.test.tsx`)
- 18テスト
- 以下の機能をカバー：
  - 日付番号の表示
  - 当月/他月のスタイル適用
  - 今日のハイライト
  - リフレクションインジケーター表示
  - 複数リフレクション時のカウント表示
  - クリックインタラクション
  - キーボード操作（Enter、Space）
  - アクセシビリティ（role、aria-label、tabIndex）
  - フレームワークカラーの適用
  - 未知のフレームワークのデフォルトカラー

### ⏸️ リフレクションサービス
- モックの複雑さのため、一時的にスキップ
- 今後実装予定

## テスト作成のガイドライン

### ユニットテスト
1. **単一責任**: 各テストは1つの機能のみをテストする
2. **明確な命名**: テスト名は「should + 期待される動作」の形式で記述
3. **AAA パターン**: Arrange（準備）、Act（実行）、Assert（検証）の順序で記述

### コンポーネントテスト
1. **ユーザー視点**: ユーザーがどのように操作するかをテスト
2. **実装の詳細を避ける**: 内部の状態ではなく、UIの動作をテスト
3. **アクセシビリティ**: role、label、textなどを使用して要素を取得

### モックの使用
- 外部依存（Supabase、API呼び出しなど）は必ずモック
- `vi.mock()`を使用してモジュールをモック
- `vi.fn()`を使用して関数をモック
- `vi.spyOn()`を使用してメソッドをスパイ

## 設定ファイル

### vitest.config.ts
- Vitestの設定ファイル
- React plugin、jsdom環境、セットアップファイルなどを設定

### src/tests/setup.ts
- テスト実行前に実行されるセットアップファイル
- @testing-library/jest-domのマッチャーを追加
- テスト後のクリーンアップを設定

## トラブルシューティング

### テストが失敗する場合
1. `pnpm install`を実行して依存関係を更新
2. `node_modules`と`.next`フォルダを削除して再インストール
3. 環境変数が正しく設定されているか確認

### モックが機能しない場合
1. モックは必ずテスト対象のインポート前に設定
2. `vi.clearAllMocks()`を`afterEach`で呼び出してモックをリセット
3. `vi.mock()`は必ずファイルのトップレベルで呼び出す

## 今後の予定

- [ ] リフレクションサービスのテストを修正
- [x] カレンダーコンポーネントのテストを追加
- [ ] その他のコンポーネントのテストを追加
- [ ] E2Eテストの追加（Playwright）
- [ ] テストカバレッジを80%以上に向上
